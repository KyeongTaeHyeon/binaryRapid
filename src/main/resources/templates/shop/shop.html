<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>지역별/테마별 맛집</title>
        <link rel="stylesheet" th:href="@{/css/reset.css}"/>
        <link rel="stylesheet" th:href="@{/css/common.css}"/>
        <link rel="stylesheet" th:href="@{/css/shop.css}"/>
    </head>
    <body th:attr="data-authenticated=${session.loginUser != null}, data-login-url=@{/login}">
        <div id="wrapper">
            <header id="header" th:replace="~{fragments/header :: header}"></header>

            <main id="main">
                <div id="filterWrapper">
                    <h1 style="margin-bottom: 20px">지역별/테마별</h1>

                    <form id="filterForm" method="get" th:action="@{/shop}" th:object="${searchForm}">
                        <div class="filters">
                            <th:block th:each="group : ${filterGroups}">
                                <div th:if="${!group.hideHeader}" class="filterSection filterOutline">
                                    <div class="filterHeaderTitle" th:text="${group.majorName} + ' ▲'">제목</div>
                                    <div class="filterGroupWrap" style="display: none;">
                                        <th:block th:each="minorEntry : ${group.minorMap}">
                                            <div>
                                                <div class="filterTitle" th:text="${minorEntry.key}">소제목</div>
                                                <div class="filterList">
                                                    <ul class="filterContents"
                                                        th:classappend="${minorEntry.value.size() >= 12} ? 'collapsed' : ''">
                                                        <li class="filterAll" data-value="all"
                                                            th:data-title="${minorEntry.key}">전체
                                                        </li>
                                                        <li th:each="item : ${minorEntry.value}"
                                                            th:text="${item.name}"
                                                            th:data-value="${item.id}"
                                                            th:data-title="${minorEntry.key}">
                                                        </li>
                                                    </ul>
                                                    <div th:if="${minorEntry.value.size() >= 12}"
                                                         class="filterMoreBtn"
                                                         onclick="toggleFilter(this)">...
                                                    </div>
                                                </div>
                                            </div>
                                        </th:block>
                                    </div>
                                </div>

                                <div th:if="${group.hideHeader}" class="filterOutline">
                                    <th:block th:each="minorEntry : ${group.minorMap}">
                                        <div class="filterTitle" th:text="${minorEntry.key}">소제목</div>
                                        <div class="filterList">
                                            <ul class="filterContents"
                                                th:classappend="${minorEntry.value.size() >= 12} ? 'collapsed' : ''">
                                                <li class="filterAll" data-value="all"
                                                    th:data-title="${minorEntry.key}">전체
                                                </li>
                                                <li th:each="item : ${minorEntry.value}"
                                                    th:text="${item.name}"
                                                    th:data-value="${item.id}"
                                                    th:data-title="${minorEntry.key}">
                                                </li>
                                            </ul>
                                            <div th:if="${minorEntry.value.size() >= 12}"
                                                 class="filterMoreBtn"
                                                 onclick="toggleFilter(this)">...
                                            </div>
                                        </div>
                                    </th:block>
                                </div>
                            </th:block>
                        </div>
                    </form>
                </div>

                <div id="selectorWrapper">
                    <ul class="selectorContents"></ul>
                    <button type="button" class="btn-clear-all" style="display: none;">전체삭제</button>
                </div>

                <div id="contentWrapper">
                    <div id="contentList">
                        <div th:if="${shopList.isEmpty()}" style="text-align: center; padding: 50px;">
                            검색 결과가 없습니다.
                        </div>
                        <div th:each="shop:${shopList}">
                            <div class="contentItem">
                                <a th:href="@{/shop/{id}(id=${shop.shopId})}">
                                    <div class="contentImage">
                                        <img th:if="${shop.imgUrl != null}"
                                             th:src="${shop.imgUrl}"
                                             th:alt="${shop.shopName}"/>
                                        <div th:if="${shop.imgUrl == null}" class="no-image">No Image</div>
                                    </div>

                                    <div class="contentsInfo">
                                        <div class="contentTitle" th:text="${shop.shopName}"></div>

                                        <div class="contentCategory">
                                            <ul class="categoryList">
                                                <li th:each="category : ${shop.categories}">
                                                    <span class="badge"
                                                          th:text="${category.categoryName}">
                                                    </span>
                                                </li>
                                            </ul>
                                        </div>

                                        <div class="contentDescription"
                                             th:text="${shop.shopContent}">
                                        </div>
                                    </div>
                                </a>

                                <!-- ✅ 좋아요 버튼 (SSR에서 상태 주입) -->
                                <button class="contentLike"
                                        type="button"
                                        th:if="${session.loginUser != null}"
                                        th:classappend="${shop.liked} ? ' active' : ''"
                                        th:attr="data-shop-id=${shop.shopId},
                                                data-liked=${shop.liked},
                                                aria-pressed=${shop.liked}">
                                </button>
                            </div>

                        </div>
                    </div>

                    <div id="contentNav"></div>
                </div>
            </main>

            <footer id="footer" th:replace="~{fragments/footer :: footer}"></footer>
        </div>

        <script th:src="@{/js/common.js}"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
        <script type="module" th:src="@{/js/shop.js}"></script>

    </body>
</html>
