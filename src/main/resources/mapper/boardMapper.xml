<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.binary.rapid.board.mapper.BoardMapper">

    <insert id="saveBoard" parameterType="com.binary.rapid.board.dto.BoardDto" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO tb_board (category, title, contents, user_id, create_date)
        VALUES (#{category}, #{title}, #{contents}, #{userId}, NOW())
    </insert>

    <select id="selectBoardList" resultType="com.binary.rapid.board.dto.BoardDto">
        SELECT b.id          AS id,
               b.category    AS category,
               b.title       AS title,
               b.contents    AS contents,
               b.user_id     AS userId,
               b.create_date AS createDate,
               u.nickname    AS writerName
        FROM tb_board b
                 LEFT JOIN tb_user u ON b.user_id = u.user_id
        WHERE b.delete_date IS NULL
        ORDER BY b.id DESC
    </select>

    <select id="selectBoardDetail" parameterType="int" resultType="com.binary.rapid.board.dto.BoardDto">
        SELECT b.id          AS id,
               b.category    AS category,
               b.title       AS title,
               b.contents    AS contents,
               b.user_id     AS userId,
               b.create_date AS createDate,
               u.nickname    AS writerName
        FROM tb_board b
                 LEFT JOIN tb_user u ON b.user_id = u.user_id
        WHERE b.id = #{id}
          AND b.delete_date IS NULL
    </select>

    <update id="updateBoard" parameterType="com.binary.rapid.board.dto.BoardDto">
        UPDATE tb_board
        SET category    = #{category},
            title       = #{title},
            contents    = #{contents},
            update_date = NOW()
        WHERE id = #{id}
          AND user_id = #{userId}
    </update>

    <update id="deleteBoard" parameterType="int">
        UPDATE tb_board
        SET delete_date = NOW()
        WHERE id = #{id}
    </update>

    <update id="deleteCommentsByBoardId" parameterType="int">
        UPDATE tb_boardComment
        SET delete_date = NOW()
        WHERE id = #{id}
    </update>

    <select id="selectCommentList" parameterType="int" resultType="com.binary.rapid.board.dto.BoardCommentDto">
        SELECT c.id          AS id,
               c.comment_seq AS commentSeq,
               c.comment     AS comment,
               c.user_id     AS userId,
               u.nickname    AS userName,
               c.create_date AS createDate
        FROM tb_boardComment c
                 LEFT JOIN tb_user u ON c.user_id = u.user_id
        WHERE c.id = #{id}
          AND c.delete_date IS NULL
        ORDER BY c.comment_seq ASC
    </select>

    <insert id="insertComment" parameterType="com.binary.rapid.board.dto.BoardCommentDto">
        INSERT INTO tb_boardComment (id, comment_seq, comment, user_id, create_date)
        VALUES (#{id},
                (SELECT IFNULL(MAX(c.comment_seq), 0) + 1 FROM tb_boardComment c WHERE c.id = #{id}),
                #{comment},
                #{userId},
                NOW())
    </insert>

    <update id="updateComment" parameterType="com.binary.rapid.board.dto.BoardCommentDto">
        UPDATE tb_boardComment
        SET comment     = #{comment},
            update_date = NOW()
        WHERE id = #{id}
          AND comment_seq = #{commentSeq}
    </update>

    <update id="deleteComment">
        UPDATE tb_boardComment
        SET delete_date = NOW()
        WHERE id = #{id}
          AND comment_seq = #{commentSeq}
    </update>

    <insert id="insertBoardFile" parameterType="com.binary.rapid.board.dto.BoardFileDto">
        INSERT INTO tb_boardFile (id, file_seq, file_addr, user_id, create_date)
        VALUES (#{id}, #{fileSeq}, #{fileAddr}, #{userId}, NOW())
    </insert>

    <select id="selectFileList" parameterType="int" resultType="com.binary.rapid.board.dto.BoardFileDto">
        SELECT id          AS id,
               file_seq    AS fileSeq,
               file_addr   AS fileAddr,
               user_id     AS userId,
               create_date AS createDate
        FROM tb_boardFile
        WHERE id = #{id}
          AND delete_date IS NULL
        ORDER BY file_seq ASC
    </select>

    <select id="selectBoardFile" resultType="com.binary.rapid.board.dto.BoardFileDto">
        SELECT id          AS id,
               file_seq    AS fileSeq,
               file_addr   AS fileAddr,
               user_id     AS userId,
               create_date AS createDate
        FROM tb_boardFile
        WHERE id = #{id}
          AND file_seq = #{fileSeq}
          AND delete_date IS NULL
        LIMIT 1
    </select>

    <update id="deleteBoardFile">
        UPDATE tb_boardFile
        SET delete_date = NOW(),
            update_date = NOW()
        WHERE id = #{id}
          AND file_seq = #{fileSeq}
          AND delete_date IS NULL
    </update>

    <select id="selectMaxFileSeq" resultType="int">
        SELECT IFNULL(MAX(file_seq), 0)
        FROM tb_boardFile
        WHERE id = #{id}
          AND delete_date IS NULL
    </select>

    <select id="selectAllFileList" parameterType="int" resultType="com.binary.rapid.board.dto.BoardFileDto">
        SELECT id          AS id,
               file_seq    AS fileSeq,
               file_addr   AS fileAddr,
               user_id     AS userId,
               create_date AS createDate,
               delete_date AS deleteDate
        FROM tb_boardFile
        WHERE id = #{id}
        ORDER BY file_seq ASC
    </select>

    <update id="deleteBoardFilesByBoardId" parameterType="int">
        UPDATE tb_boardFile
        SET delete_date = NOW(),
            update_date = NOW()
        WHERE id = #{id}
          AND delete_date IS NULL
    </update>

</mapper>
